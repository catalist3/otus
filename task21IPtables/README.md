#### Описание домашнего задания
Сценарии iptables:

1.Реализовать ```knocking port```, centralRouter может попасть на ssh inetrRouter через knock скрипт.
Пример в материалах.<br />
2.добавить inetRouter2, который виден(маршрутизируется (host-only тип сети для виртуалки)) с хоста или форвардится порт через локалхост.<br />
3.Запустить nginx на centralServer.Пробросить 80й порт на inetRouter2 8080.Дефолт в инет оставить через inetRouter.
реализовать проход на 80й порт без маскарадинга<br />
Для выполнения данного ДЗ воспользуемся стендом из ДЗ "Архитектура сетей" и добавим к этому стенду сервер inetRouter2

#### Реализация knocking port

У нас есть сервер inetRouter с IP-адресом 192.168.255.1. Нам необходимо запретить до него доступ всем, кроме тех, кто знает «как правильно постучаться». Последовательность портов будет такая: 8881 7777 9991.<br />
Создадим соответствующие правила. Наш файл ```/etc/iptables/rules.v4``` будет иметь следующиее содержание:

```
*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:TRAFFIC - [0:0]
:SSH-INPUT - [0:0]
:SSH-INPUTTWO - [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -s 192.168.56.0/24 -m tcp --dport 22 -j ACCEPT
-A INPUT -j TRAFFIC
-A TRAFFIC -p icmp --icmp-type any -j ACCEPT
-A TRAFFIC -m state --state ESTABLISHED,RELATED -j ACCEPT
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 22 -m recent --rcheck --seconds 30 --name SSH2 -j ACCEPT
-A TRAFFIC -m state --state NEW -m tcp -p tcp -m recent --name SSH2 --remove -j DROP
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 9991 -m recent --rcheck --name SSH1 -j SSH-INPUTTWO
-A TRAFFIC -m state --state NEW -m tcp -p tcp -m recent --name SSH1 --remove -j DROP
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 7777 -m recent --rcheck --name SSH0 -j SSH-INPUT
-A TRAFFIC -m state --state NEW -m tcp -p tcp -m recent --name SSH0 --remove -j DROP
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 8881 -m recent --name SSH0 --set -j DROP
-A SSH-INPUT -m recent --name SSH1 --set -j DROP   
-A SSH-INPUTTWO -m recent --name SSH2 --set -j DROP
-A TRAFFIC -j DROP
COMMIT
# Completed on Fri Nov  3 12:29:45 2023
# Generated by iptables-save v1.8.7 on Fri Nov  3 12:29:45 2023
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth2 -j MASQUERADE
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT
```
Попробууме кратко объяснить работу правил. recent — это специальный критерий, позволяющий запоминать проходящие через него пакеты(их количество, время поступления, адрес источника), а затем использовать полученную информацию для принятия решений. Поледоввательность проверки нашего роутера касательно используемых портов будет такой ```8881 7777 9991```. В нашем случае первое сработавшее правило ``` -A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 8881 -m recent --name SSH0 --set -j DROP``` занесет наш адрес источника(параметр --set) в список SSH0(параметр --name) и отбросит пакет.<br />
Следующий "стук" будет обработан правилом ```A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 7777 -m recent --rcheck --name SSH0 -j SSH-INPUT``` где будет проверен(--rcheck) факт нахождения нас в списке SSH0, и как результат нас перекинут в цепочку SSH-INPUT. Где опять с помощью модуля recent нас переназначат в другой список SSH1.<br />
Следующий "стук" обработает правило ```-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 9991 -m recent --rcheck --name SSH1 -j SSH-INPUTTWO```, здесь нас вновь проверят по порту и наличию в списке SSH1, и перебросят в цепочку SSH-INPUTTWO, и согласно правилу ```-A SSH-INPUTTWO -m recent --name SSH2 --set -j DROP``` назначат в список SSH2.<br />
А уже правило ```A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 22 -m recent --rcheck --seconds 30 --name SSH2 -j ACCEPT``` проверив время от последнего "стука"(--seconds 30) и наличие нас списке SSH2 разрешит нам доступ к узлу.

Проверим возможность логина по ssh до применения правил:
```
root@centralServer:~# ssh vagrant@192.168.255.1
vagrant@192.168.255.1's password: 
Last login: Fri Nov  3 12:08:00 2023 from 10.0.2.2
vagrant@inetRouter:~$ exit
logout
```
И после:
```
root@centralServer:~# ssh vagrant@192.168.255.1
ssh: connect to host 192.168.255.1 port 22: Connection timed out

```
С использованием nmap и скрипта попробуем проверить работу правил.<br />
Содержание скрипта knock.sh:<br />
```
#!/bin/bash
HOST=$1
shift
for ARG in "$@"
do
  sudo nmap -Pn --max-retries 0 -p $ARG $HOST
done
```

Установим nmap:
```
root@centralRouter:~# apt install nmap
```
Запускаем скрипт и пробуем получить доступ по ssh:
```
root@centralRouter:~# ./knock.sh 192.168.255.1 8881 7777 9991
Starting Nmap 7.80 ( https://nmap.org ) at 2023-11-03 17:44 UTC
Warning: 192.168.255.1 giving up on port because retransmission cap hit (0).
Nmap scan report for _gateway (192.168.255.1)
Host is up (0.0011s latency).

PORT     STATE    SERVICE
8881/tcp filtered galaxy4d
MAC Address: 08:00:27:AC:22:01 (Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 0.37 seconds
Starting Nmap 7.80 ( https://nmap.org ) at 2023-11-03 17:44 UTC
Warning: 192.168.255.1 giving up on port because retransmission cap hit (0).
Nmap scan report for _gateway (192.168.255.1)
Host is up (0.0013s latency).

PORT     STATE    SERVICE
7777/tcp filtered cbt
MAC Address: 08:00:27:AC:22:01 (Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 0.31 seconds
Starting Nmap 7.80 ( https://nmap.org ) at 2023-11-03 17:44 UTC
Warning: 192.168.255.1 giving up on port because retransmission cap hit (0).
Nmap scan report for _gateway (192.168.255.1)
Host is up (0.0021s latency).

PORT     STATE    SERVICE
9991/tcp filtered issa
MAC Address: 08:00:27:AC:22:01 (Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 0.29 seconds
```
```
root@centralRouter:~# ssh vagrant@192.168.255.1
The authenticity of host '192.168.255.1 (192.168.255.1)' can't be established.
ED25519 key fingerprint is SHA256:SCuE5S9UNvytf3eIE+zaRlM/t8P0uVGLQQ39K37TrEU.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '192.168.255.1' (ED25519) to the list of known hosts.
vagrant@192.168.255.1's password: 
Last login: Fri Nov  3 14:02:40 2023 from 192.168.0.2
vagrant@inetRouter:~$ 
```
Вход успешно выполнен.

#### Запустить nginx на centralServer.Пробросить 80й порт на inetRouter2 8080

Установим nginx на centralServer и проверим установку:
```
root@centralServer:~# curl http://192.168.50.12
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```
Установим iptables на inetRouter2
```
apt-get install iptables-persistent
``` 
В настройках virtualbox в параметрах NAT-интерфейса через который ВМ связаны с "внешним" миром настроим port-forwarding

![Alt text](https://github.com/catalist3/otus/blob/master/task21IPtables/portforward_vbox.png?raw=true)

По адресу 127.0.0.1:1234 мы будем пробовать достучаться до внутреннего веб-сервера.<br />
На ВМ Inetrouter2 создадим два правила.<br />
DNAT для смены адреса назначения:
```
iptables -t nat -A PREROUTING -i eth0 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 192.168.0.2:80
```
SNAT для изменения адреса источника поскольку наш веб-сервер ожидает запросов только из сети 192.168.0.0/24
```
iptables -t nat -A POSTROUTING -o eth1 -p tcp --dport 80 -d 192.168.0.2 -j SNAT --to-source 192.168.0.3
```
Ну и про "маскарадинг" не забываем:
```
iptables -t nat -A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
```
Настройки маршрута по умолчанию на ВМ centralServer не меняем, основной трафик должен ходит через ВМ inetRouter.

Теперь проверим доступ до опубликованного веб-сервера:<br />
![Alt text](https://github.com/catalist3/otus/blob/master/task21IPtables/welcome_web.png?raw=true)

Проверим что наш веб-сервер ходит наружу через inetRouter:<br />
```
root@centralServer:~# traceroute google.ru
traceroute to google.ru (142.250.184.131), 64 hops max
  1   192.168.0.1  1.419ms  1.311ms  1.562ms 
  2   192.168.255.1  2.288ms  2.110ms  0.867ms 
  3   10.0.2.2  2.290ms  1.942ms  2.574ms 
  4   *  *  * 
  5   *  *  * 
  6   212.48.195.244  6.936ms  5.945ms  5.492ms 
  7   212.48.194.134  6.591ms  5.535ms  8.362ms 
  8   188.254.2.6  12.344ms  9.685ms  12.328ms 
  9   87.226.194.47  10.818ms  12.126ms  10.184ms 
 10   74.125.244.180  7.725ms  6.681ms  7.312ms 
 11   142.250.239.234  17.592ms  16.072ms  16.419ms 
 12   142.250.61.185  19.580ms  19.328ms  18.604ms 
 13   108.170.235.149  75.889ms  40.522ms  42.492ms 
 14   172.253.78.197  48.526ms  47.986ms  48.554ms 
 15   108.170.237.220  71.510ms  107.047ms  70.428ms 
 16   108.170.250.177  71.825ms  71.217ms  70.418ms 
 17   142.250.212.23  69.812ms  69.809ms  70.848ms 
 18   142.250.184.131  72.710ms  70.398ms  70.582ms 
```
Видим, что в выводе присутствуют два адреса наших ВМ-роутеров - ```192.168.0.1``` , ```192.168.255.1```.


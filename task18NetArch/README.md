##### Цель домашнего задания

Научится менять базовые сетевые настройки в Linux-based системах.

#### Задание состоит из 2-х частей: теоретической и практической.

#### В теоретической части требуется: 
Найти свободные подсети
Посчитать количество узлов в каждой подсети, включая свободные
Указать Broadcast-адрес для каждой подсети
Проверить, нет ли ошибок при разбиении

#### В практической части требуется: 
Соединить офисы в сеть согласно логической схеме и настроить роутинг
Интернет-трафик со всех серверов должен ходить через inetRouter
Все сервера должны видеть друг друга (должен проходить ping)
У всех новых серверов отключить дефолт на NAT (eth0), который vagrant поднимает для связи
Добавить дополнительные сетевые интерфейсы, если потребуется

#### 1. Теоретическая часть

Первым шагом мы рассмотрим все сети, указанные в задании. Посчитаем для них количество узлов, найдём Broadcast-адрес, проверим, нет ли ошибок при разбиении.

Расчеты можно выполнить вручную, или воспользоваться калькулятором сетей. Для примера, посчитаем одну подсеть вручную:

Симитируем большую корпоритивную сеть. Нам выдали одну подсеть из определенного в стандарте диапазона для использования в локальных сетях. Это диапазон 192.168.x.x/16, нам определили 192.168.0.0/24, её мы можем делить на нужные нам подсети. Как пример фигурирующий в нашем тестовом стенде выберем маску /28, т.е. забираем от 4-го октета ip-адреса 4 бита.Сведем атрибуты подсетей в общую таблицу:

![Alt text](https://github.com/catalist3/otus/blob/master/task18NetArch/list_subnet_example.png?raw=true)

В таблице отображены все варианты возможных в этом случае подсетей кроме первой нулевой, с самими адресами сетей и их широковещательными адресами.

Т.Е. с учетом сводного примера в таблице, адрес первой по порядку сети будет иметь вид ```192.168.0.0```, первый адрес который можно использовать для узла в этой сети будет ```192.168.0.1,``` а последним возможным ```192.168.0.14```, при этом адрес ```192.168.0.15``` будет широковещательным адресом данной подсети. Также необходимо иметь ввиду, что один адрес из возможных будет задействован как адреса шлюза по умолчанию для данной сети.

Понятно, что вести подобный расчет для всех сетей вручную накладно по времени и может привести к ошибкам. В этом случае можно воспользоваться ip-калькулятором. Данный инструмент предоставит всю необходимую информацию по атрибутам сети: адрес сети, широковещательный адрес и диапазон возможных адресов в данной подсети.

Список подсетей нашего тестового стенда:

![Alt text](https://github.com/catalist3/otus/blob/master/task18NetArch/list_subnet_for_stend.png?raw=true)

Теперь можем приступить к настройке маршрутизации и трансляции адресов в целях обеспечения возможности узлов с локальной адресацией иметь доступ к узлам в сети ```Интернет```.

#### Настройка NAT

Так как работаем по задаче напрямую с iptables, а версия используемой ОС, ввиду некоторых проблем с синтаксисом Vagrant, это Ubuntu 22.04 нам необходимо будет выполнить некоторые дополнительные действия:

Установить утилиты iptables:

```
apt-get install iptables-persistent
```
Также необходимо иметь ввиду, что правила сохраняются в файле:

```
/etc/iptables/rules.v4
```
На ВМ InetRouter его содержимое следующее:

```
*filter

:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [37:2828]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
# Deny ping trafic
# -A INPUT -j REJECT --reject-with icmp-host-prohibited
# -A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
*nat
:PREROUTING ACCEPT [1:161]
:INPUT ACCEPT [0:0]	
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth2 -j MASQUERADE
COMMIT
```
Для включения возможности передачи трафика между сетями на ВМ InetRouter, CentralRouter, Office1Router и Office2Router необходимо включить функционал маршрутизации пакетов на основе информации содержащейся в таблице маршрутизации. Делается это путем указания параметру ```net.ipv4.ip_forward``` значения ```1```
В нашем случае для установки постоянного значения необходимо отредактировать файл  ```/etc/sysctl.conf``` , найти строку ```net.ipv4.ip_forward``` раскомментировать ее и, при необходимости установить значение ```1```. После сохранения файла применяем настройки командой ```sysctl -p```

Теперь можено переходить к настройке маршрутизации на узлах тестового стенда. Начать можно с указания на конечных узлах маршрута по умолчанию.Так в качестве ОС на тестовых ВМ используется Ubuntu 22.04, эти настройки осуществляются путем редактирования файла /etc/netplan/50-vagrant.yaml. Будем опираться на схему с указанием сетей.

![Alt text](https://github.com/catalist3/otus/blob/master/task18NetArch/schema_net_arch.png?raw=true)

Конечными узлами согласно схемы являются: centralServer, office1Server, office2Server.
В качестве примера для настройки приведем содержимое файла /etc/netplan/50-vagrant.yaml узла centralServer

```
---
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses:
      - 192.168.0.2/28
      routes:
        - to: default
          via: 192.168.0.1
    eth2:
      addresses:
      - 192.168.50.12/24
```
Шлюзом для этого узла является centralRouter чей адрес и указан внастройках маршрута по умолчанию.

```
root@centralServer:~# ip route
default via 192.168.0.1 dev eth1 proto static 
```
Для сервера office1Server адрес шлюза по умолчанию - 192.168.2.129, а для office2Server - 192.168.1.1. Продолжим разбирать маршрутизацию работая с ВМ centralServer. Проверим с помощью утилиты ping соединение до узла inetRouter

```
root@centralServer:~# ping 192.168.255.1
PING 192.168.255.1 (192.168.255.1) 56(84) bytes of data.
^C
--- 192.168.255.1 ping statistics ---
4 packets transmitted, 0 received, 100% packet loss, time 3052ms
```
Результат очевиден, ведь у ВМ inetRouter нет маршрута до сети 192.168.0.0/28. Самое время заняться настройкой статических маршрутов для специфических сетей. Сделаем это на примере inetRouter. Добавим статический маршрут до сети 192.168.0.0/28
```
ip route add 192.168.0.0/28 via 192.168.255.2
```
После этого можем вновь проверить ping от узла centralServer до inetRouter:

```
root@centralServer:~# ping 192.168.255.1
PING 192.168.255.1 (192.168.255.1) 56(84) bytes of data.
64 bytes from 192.168.255.1: icmp_seq=1 ttl=63 time=3.09 ms
64 bytes from 192.168.255.1: icmp_seq=2 ttl=63 time=3.31 ms
64 bytes from 192.168.255.1: icmp_seq=3 ttl=63 time=3.31 ms
64 bytes from 192.168.255.1: icmp_seq=4 ttl=63 time=2.88 ms
64 bytes from 192.168.255.1: icmp_seq=5 ttl=63 time=2.81 ms
^C
--- 192.168.255.1 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4010ms
rtt min/avg/max/mdev = 2.811/3.081/3.312/0.208 ms
```
Как видим - связь есть.

Необходимо иметь ввиду, что для постоянного запоминания информации о статических маршрутах команды p route add недостаточно. После перезагрузки информация о маршруте  исчезнет из таблицы машрутизации. Для того, чтобы сделать информацию о статических маршрутах постоянной необходимо отредактировать уже упомянутый файл /etc/netplan/50-vagrant.yaml. В нашем примере файл ВМ inetRouter будет иметь следующий вид:

```
---
network:
  version: 2
  renderer: networkd
  ethernets:
    eth1:
      addresses:
      - 192.168.255.1/30
      routes:
        - to: 192.168.0.0/28
          via: 192.168.255.2
    eth2:
      addresses:
      - 192.168.50.10/24
```
Естественно впоследствии необходимо будет добавлять записи в раздел routes информацию о других подсетях.
Для применения настроек не забываем дать команду ```netplan apply```

Далее с остальными сетями необходимо осуществить аналогичные действия. Описывать все конфигурации маршрутов особого смысла нет, процесс описан выше. Но рамочно отобразим логику на еще одном примере:
Согласно схемы сети:
```
192.168.2.0/26
192.168.2.64/26
192.168.2.128/26
192.168.2.192/26
```
является непосредственно присоединенными(direct connected) к office1Router. Т.Е. для того чтобы иметь доступ с centralRouter до этих сетей, необходимо определить в его конфигурации маршруты до этих сетей с указанием адреса 192.168.255.10 как адреса через который эти сети доступны. В свою очередь на office1Router можно ограничиться маршрутом по умолчанию поскольку он отвечает только за direct connected сети и имеет лишь одно соединение в сторону остальных сетей, до centralRouter.






##### Цель домашнего задания

Научится менять базовые сетевые настройки в Linux-based системах.

#### Задание состоит из 2-х частей: теоретической и практической.

#### В теоретической части требуется: 
Найти свободные подсети
Посчитать количество узлов в каждой подсети, включая свободные
Указать Broadcast-адрес для каждой подсети
Проверить, нет ли ошибок при разбиении

#### В практической части требуется: 
Соединить офисы в сеть согласно логической схеме и настроить роутинг
Интернет-трафик со всех серверов должен ходить через inetRouter
Все сервера должны видеть друг друга (должен проходить ping)
У всех новых серверов отключить дефолт на NAT (eth0), который vagrant поднимает для связи
Добавить дополнительные сетевые интерфейсы, если потребуется

#### 1. Теоретическая часть

Первым шагом мы рассмотрим все сети, указанные в задании. Посчитаем для них количество узлов, найдём Broadcast-адрес, проверим, нет ли ошибок при разбиении.

Расчеты можно выполнить вручную, или воспользоваться калькулятором сетей. Для примера, посчитаем одну подсеть вручную:

Симитируем большую корпоритивную сеть. Нам выдали одну подсеть из определенного в стандарте диапазона для использования в локальных сетях. Это диапазон 192.168.x.x/16, нам определили 192.168.0.0/24, её мы можем делить на нужные нам подсети. Как пример фигурирующий в нашем тестовом стенде выберем маску /28, т.е. забираем от 4-го октета ip-адреса 4 бита.Сведем атрибуты подсетей в общую таблицу:

![Alt text](https://github.com/catalist3/otus/blob/master/task18NetArch/list_subnet_example.png?raw=true)

В таблице отображены все варианты возможных в этом случае подсетей кроме первой нулевой, с самими адресами сетей и их широковещательными адресами.

Т.Е. с учетом сводного примера в таблице, адрес первой по порядку сети будет иметь вид ```192.168.0.0```, первый адрес который можно использовать для узла в этой сети будет ```192.168.0.1,``` а последним возможным ```192.168.0.14```, при этом адрес ```192.168.0.15``` будет широковещательным адресом данной подсети. Также необходимо иметь ввиду, что один адрес из возможных будет задействован как адреса шлюза по умолчанию для данной сети.

Понятно, что вести подобный расчет для всех сетей вручную накладно по времени и может привести к ошибкам. В этом случае можно воспользоваться ip-калькулятором. Данный инструмент предоставит всю необходимую информацию по атрибутам сети: адрес сети, широковещательный адрес и диапазон возможных адресов в данной подсети.

Список подсетей нашего тестового стенда:

![Alt text](https://github.com/catalist3/otus/blob/master/task18NetArch/list_subnet_for_stend.png?raw=true)

Теперь можем приступить к настройке маршрутизации и трансляции адресов в целях обеспечения возможности узлов с локальной адресацией иметь доступ к узлам в сети ```Интернет```.

#### Настройка NAT

Так как работаем по задаче напрямую с iptables, а версия используемой ОС, ввиду некоторых проблем с синтаксисом Vagrant, это Ubuntu 22.04 нам необходимо будет выполнить некоторые дополнительные действия:

Установить утилиты iptables:

```
apt-get install iptables-persistent
```
Также необходимо иметь ввиду, что правила сохраняются в файле:

```
/etc/iptables/rules.v4
```
На ВМ InetRouter его содержимое следующее:

```
*filter

:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [37:2828]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
# Deny ping trafic
# -A INPUT -j REJECT --reject-with icmp-host-prohibited
# -A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
*nat
:PREROUTING ACCEPT [1:161]
:INPUT ACCEPT [0:0]	
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth2 -j MASQUERADE
COMMIT
```
Для включения возможности передачи трафика между сетями на ВМ InetRouter, CentralRouter, Office1Router и Office2Router необходимо включить функционал маршрутизации пакетов на основе информации содержащейся в таблице маршрутизации. Делается это путем указания параметру ```net.ipv4.ip_forward``` значения ```1```
В нашем случае для установки постоянного значения необходимо отредактировать файл  ```/etc/sysctl.conf``` , найти строку ```net.ipv4.ip_forward``` раскомментировать ее и, при необходимости установить значение ```1```. После сохранения файла применяем настройки командой ```sysctl -p```


